<!doctype html>
<html class="no-js" lang="en" data-content_root="">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark">
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-EV8RVEFX82"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            
            gtag('config', 'G-EV8RVEFX82');
            
        </script>
    <link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />

    <link rel="shortcut icon" href="https://raw.githubusercontent.com/cleanlab/assets/a4483476d449f2f05a4c7cde329e72358099cc07/cleanlab/cleanlab_favicon.svg"/><!-- Generated with Sphinx 7.1.2 and Furo 2023.09.10 -->
        <title>cleanlab.object_detection.rank - cleanlab</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/tabs.css?v=a5c4661c" />
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/katex-math.css?v=91adb8b6" />
    <link rel="stylesheet" type="text/css" href="../../../_static/styles/furo-extensions.css?v=36a5483c" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=96bccb3e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../../index.html"><div class="brand">cleanlab</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a style="padding-bottom: 0px;" class="sidebar-brand" href="../../../index.html">
    
    <div class="sidebar-logo-container">
        <img class="sidebar-logo" src="https://raw.githubusercontent.com/cleanlab/assets/master/cleanlab/cleanlab_logo_only.png" alt="Logo" />
    </div>
    
    <span style="margin-bottom:0px" class="sidebar-brand-text">
        cleanlab
    </span>
    
</a>

<div class="centered">
    <a style="margin-top: 6px;" class="github-button" href="https://github.com/cleanlab/cleanlab" data-size="large" data-show-count="true"
    aria-label="Star cleanlab/cleanlab on GitHub">Star</a>
</div>
<form class="sidebar-search-container" method="get" action="../../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Quickstart</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../tutorials/datalab/index.html">Datalab Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of Datalab Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/datalab/datalab_quickstart.html">Detecting Common Data Issues with Datalab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/datalab/datalab_advanced.html">Advanced Data Auditing with Datalab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/datalab/text.html">Text Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/datalab/tabular.html">Tabular Data (Numeric/Categorical)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/datalab/image.html">Image Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/datalab/audio.html">Audio Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/datalab/guide/issue_type_description.html">Guide to Datalab Issue Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/datalab/workflows.html">Miscellaneous workflows with Datalab</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/improving_ml_performance.html">Improving ML Performance</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../tutorials/clean_learning/index.html">CleanLearning Tutorials</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of CleanLearning Tutorials</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/clean_learning/text.html">Text Classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../tutorials/clean_learning/tabular.html">Tabular Classification (Numeric/Categorical)</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/indepth_overview.html">Workflows of Data-Centric AI</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/dataset_health.html">Analyze Dataset-level Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/outliers.html">Outlier Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/multiannotator.html">Improving Consensus Labels for Multiannotator Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/multilabel_classification.html">Multi-Label Classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/regression.html">Noisy Labels in Regression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/token_classification.html">Token Classification (text)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/segmentation.html">Image Segmentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/object_detection.html">Object Detection</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/pred_probs_cross_val.html">Predicted Probabilities via Cross Validation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/faq.html">FAQ</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../cleanlab/datalab/index.html">datalab</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of datalab</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../cleanlab/datalab/guide/index.html">Datalab guides</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of Datalab guides</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../cleanlab/datalab/guide/issue_type_description.html">Datalab Issue Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../cleanlab/datalab/guide/custom_issue_manager.html">Creating Your Own Issues Manager</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/datalab/datalab.html">datalab</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../cleanlab/datalab/internal/index.html">internal</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of internal</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../cleanlab/datalab/internal/data.html">data</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../cleanlab/datalab/internal/data_issues.html">data_issues</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../cleanlab/datalab/internal/issue_finder.html">issue_finder</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../cleanlab/datalab/internal/factory.html">factory</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../cleanlab/datalab/internal/model_outputs.html">model_outputs</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../../../cleanlab/datalab/internal/issue_manager/index.html">issue_manager</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of issue_manager</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../cleanlab/datalab/internal/issue_manager/issue_manager.html">Base issue_manager module</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../cleanlab/datalab/internal/issue_manager/label.html">label</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../cleanlab/datalab/internal/issue_manager/outlier.html">outlier</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../cleanlab/datalab/internal/issue_manager/duplicate.html">duplicate</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../cleanlab/datalab/internal/issue_manager/noniid.html">noniid</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../cleanlab/datalab/internal/issue_manager/imbalance.html">imbalance</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../cleanlab/datalab/internal/issue_manager/underperforming_group.html">underperforming_group</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../cleanlab/datalab/internal/issue_manager/null.html">null</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../cleanlab/datalab/internal/issue_manager/data_valuation.html">data_valuation</a></li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../cleanlab/datalab/internal/issue_manager/regression/index.html">regression</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of regression</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../cleanlab/datalab/internal/issue_manager/regression/label.html">label</a></li>
</ul>
</li>
<li class="toctree-l4 has-children"><a class="reference internal" href="../../../cleanlab/datalab/internal/issue_manager/multilabel/index.html">multilabel</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of multilabel</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../cleanlab/datalab/internal/issue_manager/multilabel/label.html">label</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../cleanlab/datalab/internal/report.html">report</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../cleanlab/datalab/internal/task.html">task</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../cleanlab/classification.html">classification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cleanlab/filter.html">filter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cleanlab/rank.html">rank</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cleanlab/count.html">count</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cleanlab/dataset.html">dataset</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cleanlab/outlier.html">outlier</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cleanlab/multiannotator.html">multiannotator</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cleanlab/data_valuation.html">data_valuation</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../cleanlab/multilabel_classification/index.html">multilabel_classification</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of multilabel_classification</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/multilabel_classification/filter.html">filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/multilabel_classification/rank.html">rank</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/multilabel_classification/dataset.html">dataset</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../cleanlab/regression/index.html">regression</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of regression</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/regression/rank.html">regression.rank</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/regression/learn.html">regression.learn</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../cleanlab/token_classification/index.html">token_classification</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of token_classification</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/token_classification/filter.html">filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/token_classification/rank.html">rank</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/token_classification/summary.html">summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../cleanlab/segmentation/index.html">segmentation</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of segmentation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/segmentation/rank.html">rank</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/segmentation/filter.html">filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/segmentation/summary.html">summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../cleanlab/object_detection/index.html">object_detection</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of object_detection</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/object_detection/rank.html">rank</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/object_detection/filter.html">filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/object_detection/summary.html">summary</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../cleanlab/benchmarking/index.html">benchmarking</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of benchmarking</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/benchmarking/noise_generation.html">noise_generation</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../cleanlab/models/index.html">models</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of models</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/models/keras.html">keras</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../cleanlab/experimental/index.html">experimental</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle navigation of experimental</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/experimental/label_issues_batched.html">label_issues_batched</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/experimental/span_classification.html">span_classification</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/experimental/mnist_pytorch.html">mnist_pytorch</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/experimental/coteaching.html">coteaching</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/experimental/cifar_cnn.html">cifar_cnn</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../cleanlab/internal/index.html">internal</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><div class="visually-hidden">Toggle navigation of internal</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/internal/util.html">util</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/internal/latent_algebra.html">latent_algebra</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/internal/label_quality_utils.html">label_quality_utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/internal/multilabel_utils.html">multilabel_utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/internal/multilabel_scorer.html">multilabel_scorer</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../../cleanlab/internal/neighbor/index.html">neighbor</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><div class="visually-hidden">Toggle navigation of neighbor</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../cleanlab/internal/neighbor/knn_graph.html">knn_graph</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../cleanlab/internal/neighbor/metric.html">metric</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../cleanlab/internal/neighbor/search.html">search</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/internal/outlier.html">outlier</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/internal/token_classification_utils.html">token_classification_utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/internal/validation.html">validation</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Guides</span></p>
<ul>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../../cleanlab/datalab/guide/index.html">Datalab issue types</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><div class="visually-hidden">Toggle navigation of Datalab issue types</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/datalab/guide/issue_type_description.html">Datalab Issue Types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../cleanlab/datalab/guide/custom_issue_manager.html">Creating Your Own Issues Manager</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/cleanlab/cleanlab/blob/master/CONTRIBUTING.md">How to contribute</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://cleanlab.ai">Website</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/cleanlab/cleanlab">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/cleanlab/">PyPI</a></li>
<li class="toctree-l1"><a class="reference external" href="https://anaconda.org/conda-forge/cleanlab">Conda</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cleanlab.ai/slack">Community Discussions</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cleanlab.ai/blog/">Blog</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.youtube.com/@CleanlabAI/playlists">Videos</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cleanlab.ai/blog/data-centric-ai/">Cleanlab Studio (Easy Mode)</a></li>
<li class="toctree-l1"><a class="reference external" href="https://help.cleanlab.ai">Cleanlab Studio Docs</a></li>
</ul>

</div>


<!-- Start of versioning -->

<div class="sidebar-tree">
    <p class="caption" role="heading">
        <span class="caption-text">Versions</span>
    </p>
    <ul>
        <li class="toctree-l1">
            <a
                id="version_number"
                class="reference internal"
                href="/cleanlab-docs/"
                >stable</a
            >
        </li>
        <li class="toctree-l1">
            <a
                id="commit_hash"
                class="reference internal"
                href="/cleanlab-docs/master/"
                >developer</a
            >
        </li>
        
        <li class="toctree-l1">
            <a
                id="v2.6.6"
                class="reference internal"
                href="/cleanlab-docs/v2.6.6/"
                >v2.6.6</a
            >
        </li>
        
        <li class="toctree-l1">
            <a
                id="v2.6.5"
                class="reference internal"
                href="/cleanlab-docs/v2.6.5/"
                >v2.6.5</a
            >
        </li>
        
        <li class="toctree-l1">
            <a
                id="v2.6.4"
                class="reference internal"
                href="/cleanlab-docs/v2.6.4/"
                >v2.6.4</a
            >
        </li>
        
        <li class="toctree-l1">
            <a
                id="v2.6.3"
                class="reference internal"
                href="/cleanlab-docs/v2.6.3/"
                >v2.6.3</a
            >
        </li>
        
        <li class="toctree-l1">
            <a
                id="v2.6.2"
                class="reference internal"
                href="/cleanlab-docs/v2.6.2/"
                >v2.6.2</a
            >
        </li>
        
        <li class="toctree-l1">
            <a
                id="v2.6.1"
                class="reference internal"
                href="/cleanlab-docs/v2.6.1/"
                >v2.6.1</a
            >
        </li>
        
        <li class="toctree-l1">
            <a
                id="v2.6.0"
                class="reference internal"
                href="/cleanlab-docs/v2.6.0/"
                >v2.6.0</a
            >
        </li>
        
        <li class="toctree-l1">
            <a
                id="v2.5.0"
                class="reference internal"
                href="/cleanlab-docs/v2.5.0/"
                >v2.5.0</a
            >
        </li>
        
        <li class="toctree-l1">
            <a
                id="v2.4.0"
                class="reference internal"
                href="/cleanlab-docs/v2.4.0/"
                >v2.4.0</a
            >
        </li>
        
        <li class="toctree-l1">
            <a
                id="v2.3.1"
                class="reference internal"
                href="/cleanlab-docs/v2.3.1/"
                >v2.3.1</a
            >
        </li>
        
        <li class="toctree-l1">
            <a
                id="v2.3.0"
                class="reference internal"
                href="/cleanlab-docs/v2.3.0/"
                >v2.3.0</a
            >
        </li>
        
        <li class="toctree-l1">
            <a
                id="v2.2.0"
                class="reference internal"
                href="/cleanlab-docs/v2.2.0/"
                >v2.2.0</a
            >
        </li>
        
        <li class="toctree-l1">
            <a
                id="v2.1.0"
                class="reference internal"
                href="/cleanlab-docs/v2.1.0/"
                >v2.1.0</a
            >
        </li>
        
        <li class="toctree-l1">
            <a
                id="v2.0.0"
                class="reference internal"
                href="/cleanlab-docs/v2.0.0/"
                >v2.0.0</a
            >
        </li>
        
        <li class="toctree-l1">
            <a
                id="v1.0.1"
                class="reference internal"
                href="/cleanlab-docs/v1.0.1/"
                >v1.0.1</a
            >
        </li>
        
    </ul>
</div>

<br>
<br>

<script
    type="text/javascript"
    src="/cleanlab-docs/versioning.js"
></script>

<script type="text/javascript">
    window.addEventListener("load", () => {
        const version_number = Version.version_number;
        const commit_hash = Version.commit_hash;

        document.getElementById("version_number").innerHTML =
            "stable <code class='docutils literal notranslate'><span class='pre'> (" +
            version_number +
            ")</span></code>";
        document.getElementById("commit_hash").innerHTML =
            "master <code class='docutils literal notranslate'><span class='pre'> (" +
            commit_hash.slice(0, 7) +
            "&hellip;)</span></code>";
    });
</script>

<!-- End of versioning -->

</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          

<noscript>
  <div class="admonition warning">
    <p class="admonition-title">Warning</p>
    <p>Parts of this site uses JavaScript, but your browser does not support it.</p>
  </div>
</noscript>



<!-- Start of Version Warning Banner -->

<p id="doc_ver_warning"></p>

<script
    type="text/javascript"
    src="/cleanlab-docs/versioning.js"
></script>
<script type="text/javascript">
    window.addEventListener("load", () => {
        const version_number = Version.version_number;
        const path_arr = window.location.pathname.split("/");

        if (path_arr.includes("master")) {
            document.getElementById("doc_ver_warning").innerHTML =
            `<div class="admonition warning">
            <p class="admonition-title">Warning</p>
            <p>This version of the documentation corresponds to the master branch of <code class="docutils literal notranslate"><span class="pre">cleanlab</span></code> source code from <a href="https://github.com/cleanlab/cleanlab/">GitHub</a>. To see the documentation for the latest <code class="docutils literal notranslate"><span class="pre">pip</span></code>-installed version, click <a href="/cleanlab-docs/">here</a>.</p>
            </div>`;
        } else if (!path_arr.includes(version_number) && !path_arr.includes("stable")) {
            document.getElementById("doc_ver_warning").innerHTML =
            `<div class="admonition warning">
            <p class="admonition-title">Warning</p>
            <p>This documentation is for an old version (<code class="docutils literal notranslate"><span class="pre">master</span></code>) of <code class="docutils literal notranslate"><span class="pre">cleanlab</span></code>. To see the documentation for the latest stable version (<code class="docutils literal notranslate"><span class="pre">` + version_number + `</span></code>), click <a href="/cleanlab-docs/">here</a>.</p>
            </div>`;
        } else {
            document.getElementById("doc_ver_warning").remove();
        }
    });
</script>

<!-- End of Version Warning Banner -->

 <h1>Source code for cleanlab.object_detection.rank</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (C) 2017-2023  Cleanlab Inc.</span>
<span class="c1"># This file is part of cleanlab.</span>
<span class="c1">#</span>
<span class="c1"># cleanlab is free software: you can redistribute it and/or modify</span>
<span class="c1"># it under the terms of the GNU Affero General Public License as published</span>
<span class="c1"># by the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1"># (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1"># cleanlab is distributed in the hope that it will be useful,</span>
<span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1"># GNU Affero General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1"># You should have received a copy of the GNU Affero General Public License</span>
<span class="c1"># along with cleanlab.  If not, see &lt;https://www.gnu.org/licenses/&gt;.</span>

<span class="sd">&quot;&quot;&quot;Methods to rank and score images in an object detection dataset (object detection data), based on how likely they</span>
<span class="sd">are to contain label errors. &quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">TypeVar</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">cleanlab.internal.constants</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">ALPHA</span><span class="p">,</span>
    <span class="n">CUSTOM_SCORE_WEIGHT_BADLOC</span><span class="p">,</span>
    <span class="n">CUSTOM_SCORE_WEIGHT_OVERLOOKED</span><span class="p">,</span>
    <span class="n">CUSTOM_SCORE_WEIGHT_SWAP</span><span class="p">,</span>
    <span class="n">EPSILON</span><span class="p">,</span>
    <span class="n">EUC_FACTOR</span><span class="p">,</span>
    <span class="n">HIGH_PROBABILITY_THRESHOLD</span><span class="p">,</span>
    <span class="n">LOW_PROBABILITY_THRESHOLD</span><span class="p">,</span>
    <span class="n">MAX_ALLOWED_BOX_PRUNE</span><span class="p">,</span>
    <span class="n">TINY_VALUE</span><span class="p">,</span>
    <span class="n">TEMPERATURE</span><span class="p">,</span>
    <span class="n">LABEL_OVERLAP_THRESHOLD</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">cleanlab.internal.object_detection_utils</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">softmin1d</span><span class="p">,</span>
    <span class="n">assert_valid_aggregation_weights</span><span class="p">,</span>
    <span class="n">assert_valid_inputs</span><span class="p">,</span>
<span class="p">)</span>


<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypedDict</span>

    <span class="n">AuxiliaryTypesDict</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">(</span>
        <span class="s2">&quot;AuxiliaryTypesDict&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;pred_labels&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="s2">&quot;pred_label_probs&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="s2">&quot;pred_bboxes&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="s2">&quot;lab_labels&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="s2">&quot;lab_bboxes&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="s2">&quot;similarity_matrix&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="s2">&quot;iou_matrix&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
            <span class="s2">&quot;min_possible_similarity&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">AuxiliaryTypesDict</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;AuxiliaryTypesDict&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="get_label_quality_scores"><a class="viewcode-back" href="../../../cleanlab/object_detection/rank.html#cleanlab.object_detection.rank.get_label_quality_scores">[docs]</a><span class="k">def</span> <span class="nf">get_label_quality_scores</span><span class="p">(</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">predictions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">aggregation_weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">overlapping_label_check</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Computes a label quality score for each image of the ``N`` images in the dataset.</span>

<span class="sd">    For object detection datasets, the label quality score for an image estimates how likely it has been correctly labeled.</span>
<span class="sd">    Lower scores indicate images whose annotation is more likely imperfect.</span>
<span class="sd">    Annotators may have mislabeled an image because they:</span>

<span class="sd">    - overlooked an object (missing annotated bounding box),</span>
<span class="sd">    - chose the wrong class label for an annotated box in the correct location,</span>
<span class="sd">    - imperfectly annotated the location/edges of a bounding box.</span>

<span class="sd">    Any of these annotation errors should lead to an image with a lower label quality score. This quality score is between 0 and 1.</span>

<span class="sd">    - 1 - clean label (given label is likely correct).</span>
<span class="sd">    - 0 - dirty label (given label is likely incorrect).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    labels:</span>
<span class="sd">        A list of ``N`` dictionaries such that ``labels[i]`` contains the given labels for the `i`-th image.</span>
<span class="sd">        Refer to documentation for this argument in :py:func:`find_label_issues &lt;cleanlab.object_detection.filter.find_label_issues&gt;` for further details.</span>

<span class="sd">    predictions:</span>
<span class="sd">        A list of ``N`` ``np.ndarray`` such that ``predictions[i]`` corresponds to the model predictions for the `i`-th image.</span>
<span class="sd">        Refer to documentation for this argument in :py:func:`find_label_issues &lt;cleanlab.object_detection.filter.find_label_issues&gt;` for further details.</span>

<span class="sd">    verbose : bool, default = True</span>
<span class="sd">      Set to ``False`` to suppress all print statements.</span>

<span class="sd">    aggregation_weights:</span>
<span class="sd">       Optional dictionary to specify weights for aggregating quality scores for subtype of label issue into an overall label quality score for the image.</span>
<span class="sd">       Its keys are: &quot;overlooked&quot;, &quot;swap&quot;, &quot;badloc&quot;, and values should be nonnegative weights that sum to 1.</span>
<span class="sd">       Increase one of these weights to prioritize images with bounding boxes that were either:</span>
<span class="sd">       missing in the annotations (overlooked object), annotated with the wrong class label (class for the object should be swapped to another class), or annotated in a suboptimal location (badly located).</span>

<span class="sd">       swapped examples, bad location examples, and overlooked examples.</span>
<span class="sd">       It is important to ensure that the weights are non-negative values and that their sum equals 1.0.</span>

<span class="sd">    overlapping_label_check : bool, default = True</span>
<span class="sd">        If True, boxes annotated with more than one class label have their swap score penalized. Set this to False if you are not concerned when two very similar boxes exist with different class labels in the given annotations.</span>

<span class="sd">    Returns</span>
<span class="sd">    ---------</span>
<span class="sd">    label_quality_scores:</span>
<span class="sd">        Array of shape ``(N, )`` of scores between 0 and 1, one per image in the object detection dataset.</span>
<span class="sd">        Lower scores indicate images that are more likely mislabeled.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;objectlab&quot;</span>
    <span class="n">probability_threshold</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">assert_valid_inputs</span><span class="p">(</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
        <span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="n">probability_threshold</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">aggregation_weights</span> <span class="o">=</span> <span class="n">_get_aggregation_weights</span><span class="p">(</span><span class="n">aggregation_weights</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_compute_label_quality_scores</span><span class="p">(</span>
        <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
        <span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="n">probability_threshold</span><span class="p">,</span>
        <span class="n">aggregation_weights</span><span class="o">=</span><span class="n">aggregation_weights</span><span class="p">,</span>
        <span class="n">overlapping_label_check</span><span class="o">=</span><span class="n">overlapping_label_check</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="issues_from_scores"><a class="viewcode-back" href="../../../cleanlab/object_detection/rank.html#cleanlab.object_detection.rank.issues_from_scores">[docs]</a><span class="k">def</span> <span class="nf">issues_from_scores</span><span class="p">(</span><span class="n">label_quality_scores</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert label quality scores to a list of indices of images with issues sorted from most to least severe cut off at threshold.</span>

<span class="sd">    Returns the list of indices of images with issues sorted from most to least severe cut off at threshold.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    label_quality_scores:</span>
<span class="sd">        Array of shape ``(N, )`` of scores between 0 and 1, one per image in the object detection dataset.</span>
<span class="sd">        Lower scores indicate images are more likely to contain a label issue.</span>

<span class="sd">    threshold:</span>
<span class="sd">        Label quality scores above the threshold are not considered to be label issues. The corresponding examples&#39; indices are omitted from the returned array.</span>

<span class="sd">    Returns</span>
<span class="sd">    ---------</span>
<span class="sd">    issue_indices:</span>
<span class="sd">        Array of issue indices sorted from most to least severe who&#39;s label quality scores fall below the threshold if one is provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">threshold</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            Threshold is a cutoff of label_quality_scores and therefore should be &lt;= 1.</span>
<span class="s2">            &quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="n">issue_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">label_quality_scores</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">issue_vals</span> <span class="o">=</span> <span class="n">label_quality_scores</span><span class="p">[</span><span class="n">issue_indices</span><span class="p">]</span>
    <span class="n">sorted_idx</span> <span class="o">=</span> <span class="n">issue_vals</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">issue_indices</span><span class="p">[</span><span class="n">sorted_idx</span><span class="p">]</span></div>


<span class="k">def</span> <span class="nf">_compute_label_quality_scores</span><span class="p">(</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">predictions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">method</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;objectlab&quot;</span><span class="p">,</span>
    <span class="n">aggregation_weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">overlapping_label_check</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Internal function to prune extra bounding boxes and compute label quality scores based on passed in method.&quot;&quot;&quot;</span>

    <span class="n">pred_probs_prepruned</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">min_pred_prob</span> <span class="o">=</span> <span class="n">_get_min_pred_prob</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
    <span class="n">aggregation_weights</span> <span class="o">=</span> <span class="n">_get_aggregation_weights</span><span class="p">(</span><span class="n">aggregation_weights</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">_prune_by_threshold</span><span class="p">(</span>
            <span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">min_pred_prob</span> <span class="o">-</span> <span class="n">threshold</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.001</span> <span class="ow">and</span> <span class="n">threshold</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">pred_probs_prepruned</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># the provided threshold is the threshold used for pre_pruning the pred_probs during model prediction.</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">threshold</span> <span class="o">=</span> <span class="n">min_pred_prob</span>  <span class="c1"># assume model was not pre_pruned if no threshold was provided</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;objectlab&quot;</span><span class="p">:</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">_get_subtype_label_quality_scores</span><span class="p">(</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">predictions</span><span class="o">=</span><span class="n">predictions</span><span class="p">,</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">ALPHA</span><span class="p">,</span>
            <span class="n">low_probability_threshold</span><span class="o">=</span><span class="n">LOW_PROBABILITY_THRESHOLD</span><span class="p">,</span>
            <span class="n">high_probability_threshold</span><span class="o">=</span><span class="n">HIGH_PROBABILITY_THRESHOLD</span><span class="p">,</span>
            <span class="n">temperature</span><span class="o">=</span><span class="n">TEMPERATURE</span><span class="p">,</span>
            <span class="n">aggregation_weights</span><span class="o">=</span><span class="n">aggregation_weights</span><span class="p">,</span>
            <span class="n">overlapping_label_check</span><span class="o">=</span><span class="n">overlapping_label_check</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Invalid method: &#39;</span><span class="si">{}</span><span class="s2">&#39; is not a valid method for computing label quality scores. Please use the &#39;objectlab&#39; method.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">method</span>
            <span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">scores</span>


<span class="k">def</span> <span class="nf">_get_min_pred_prob</span><span class="p">(</span>
    <span class="n">predictions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns min pred_prob out of all predictions.&quot;&quot;&quot;</span>
    <span class="n">pred_probs</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>  <span class="c1"># avoid calling np.min on empty array.</span>
    <span class="k">for</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">class_prediction</span> <span class="ow">in</span> <span class="n">prediction</span><span class="p">:</span>
            <span class="n">pred_probs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">class_prediction</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]))</span>

    <span class="n">min_pred_prob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pred_probs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">min_pred_prob</span>


<span class="k">def</span> <span class="nf">_prune_by_threshold</span><span class="p">(</span>
    <span class="n">predictions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Removes predicted bounding boxes from predictions who&#39;s pred_prob is below the cuttoff threshold.&quot;&quot;&quot;</span>

    <span class="n">predictions_copy</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
    <span class="n">num_ann_to_zero</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">total_ann</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">idx_predictions</span><span class="p">,</span> <span class="n">prediction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">predictions_copy</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">idx_class</span><span class="p">,</span> <span class="n">class_prediction</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prediction</span><span class="p">):</span>
            <span class="n">filtered_class_prediction</span> <span class="o">=</span> <span class="n">class_prediction</span><span class="p">[</span><span class="n">class_prediction</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">class_prediction</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">total_ann</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_class_prediction</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">num_ann_to_zero</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">predictions_copy</span><span class="p">[</span><span class="n">idx_predictions</span><span class="p">][</span><span class="n">idx_class</span><span class="p">]</span> <span class="o">=</span> <span class="n">filtered_class_prediction</span>

    <span class="n">p_ann_pruned</span> <span class="o">=</span> <span class="n">total_ann</span> <span class="ow">and</span> <span class="n">num_ann_to_zero</span> <span class="o">/</span> <span class="n">total_ann</span> <span class="ow">or</span> <span class="mi">0</span>  <span class="c1"># avoid division by zero</span>
    <span class="k">if</span> <span class="n">p_ann_pruned</span> <span class="o">&gt;</span> <span class="n">MAX_ALLOWED_BOX_PRUNE</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Pruning with threshold==</span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2"> prunes </span><span class="si">{</span><span class="n">p_ann_pruned</span><span class="si">}</span><span class="s2">% labels. Consider lowering the threshold.&quot;</span><span class="p">,</span>
            <span class="ne">UserWarning</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Pruning </span><span class="si">{</span><span class="n">num_ann_to_zero</span><span class="si">}</span><span class="s2"> predictions out of </span><span class="si">{</span><span class="n">total_ann</span><span class="si">}</span><span class="s2"> using threshold==</span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">. These predictions are no longer considered as potential candidates for identifying label issues as their similarity with the given labels is no longer considered.&quot;</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">predictions_copy</span>


<span class="k">def</span> <span class="nf">_separate_label</span><span class="p">(</span><span class="n">label</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Separates labels into bounding box and class label lists.&quot;&quot;&quot;</span>
    <span class="n">bboxes</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="s2">&quot;bboxes&quot;</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">label</span><span class="p">[</span><span class="s2">&quot;labels&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">bboxes</span><span class="p">,</span> <span class="n">labels</span>


<span class="c1"># TODO: make object detection work for all predicted probabilities</span>
<span class="k">def</span> <span class="nf">_separate_prediction_all_preds</span><span class="p">(</span>
    <span class="n">prediction</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="n">pred_bboxes</span><span class="p">,</span> <span class="n">pred_labels</span><span class="p">,</span> <span class="n">det_probs</span> <span class="o">=</span> <span class="n">prediction</span>
    <span class="k">return</span> <span class="n">pred_bboxes</span><span class="p">,</span> <span class="n">pred_labels</span><span class="p">,</span> <span class="n">det_probs</span>


<span class="k">def</span> <span class="nf">_separate_prediction_single_box</span><span class="p">(</span>
    <span class="n">prediction</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Separates predictions into class labels, bounding boxes and pred_prob lists&quot;&quot;&quot;</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">boxes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">prediction_class</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prediction</span><span class="p">):</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">idx</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">prediction_class</span><span class="p">))</span>
        <span class="n">boxes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">prediction_class</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="n">bboxes</span> <span class="o">=</span> <span class="p">[</span><span class="n">box</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">]</span>
    <span class="n">pred_probs</span> <span class="o">=</span> <span class="p">[</span><span class="n">box</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">box</span> <span class="ow">in</span> <span class="n">boxes</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">bboxes</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">labels</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pred_probs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_prediction_type</span><span class="p">(</span><span class="n">prediction</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="ow">and</span> <span class="n">prediction</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">prediction</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="ow">and</span> <span class="n">prediction</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">prediction</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;all_pred&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;single_pred&quot;</span>


<span class="k">def</span> <span class="nf">_separate_prediction</span><span class="p">(</span>
    <span class="n">prediction</span><span class="p">,</span> <span class="n">prediction_type</span><span class="o">=</span><span class="s2">&quot;single_pred&quot;</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns bbox, label and pred_prob values for prediction.&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">prediction_type</span> <span class="o">==</span> <span class="s2">&quot;all_pred&quot;</span><span class="p">:</span>
        <span class="n">boxes</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">pred_probs</span> <span class="o">=</span> <span class="n">_separate_prediction_all_preds</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">boxes</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">pred_probs</span> <span class="o">=</span> <span class="n">_separate_prediction_single_box</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">pred_probs</span>


<span class="k">def</span> <span class="nf">_mod_coordinates</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes is a list of xyxy coordinates and returns them in dictionary format.&quot;&quot;&quot;</span>

    <span class="n">wd</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x1&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;y1&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;x2&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">&quot;y2&quot;</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">3</span><span class="p">]}</span>
    <span class="k">return</span> <span class="n">wd</span>


<span class="k">def</span> <span class="nf">_get_overlap</span><span class="p">(</span><span class="n">bb1</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">bb2</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes in two bounding boxes `bb1` and `bb2` and returns their IoU overlap.&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">_get_iou</span><span class="p">(</span><span class="n">_mod_coordinates</span><span class="p">(</span><span class="n">bb1</span><span class="p">),</span> <span class="n">_mod_coordinates</span><span class="p">(</span><span class="n">bb2</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_get_overlap_matrix</span><span class="p">(</span><span class="n">bb1_list</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">bb2_list</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes in two lists of bounding boxes and returns an IoU matrix where IoU[i][j] is the overlap between</span>
<span class="sd">    the i-th box in `bb1_list` and the j-th box in `bb2_list`.&quot;&quot;&quot;</span>
    <span class="n">wd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bb1_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bb2_list</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bb1_list</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bb2_list</span><span class="p">)):</span>
            <span class="n">wd</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_overlap</span><span class="p">(</span><span class="n">bb1_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bb2_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">wd</span>


<span class="k">def</span> <span class="nf">_get_iou</span><span class="p">(</span><span class="n">bb1</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">bb2</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the Intersection over Union (IoU) of two bounding boxes.</span>
<span class="sd">    I&#39;ve modified this to calculate overlap ratio in the line:</span>
<span class="sd">    iou = np.clip(intersection_area / float(min(bb1_area,bb2_area)),0.0,1.0)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    bb1 : dict</span>
<span class="sd">        Keys: {&#39;x1&#39;, &#39;x2&#39;, &#39;y1&#39;, &#39;y2&#39;}</span>
<span class="sd">        The (x1, y1) position is at the top left corner,</span>
<span class="sd">        the (x2, y2) position is at the bottom right corner</span>
<span class="sd">    bb2 : dict</span>
<span class="sd">        Keys: {&#39;x1&#39;, &#39;x2&#39;, &#39;y1&#39;, &#39;y2&#39;}</span>
<span class="sd">        The (x, y) position is at the top left corner,</span>
<span class="sd">        the (x2, y2) position is at the bottom right corner</span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        in [0, 1]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># determine the coordinates of the intersection rectangle</span>
    <span class="n">x_left</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bb1</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">],</span> <span class="n">bb2</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">])</span>
    <span class="n">y_top</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">bb1</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">],</span> <span class="n">bb2</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">])</span>
    <span class="n">x_right</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bb1</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">],</span> <span class="n">bb2</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">])</span>
    <span class="n">y_bottom</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">bb1</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">],</span> <span class="n">bb2</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">x_right</span> <span class="o">&lt;</span> <span class="n">x_left</span> <span class="ow">or</span> <span class="n">y_bottom</span> <span class="o">&lt;</span> <span class="n">y_top</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.0</span>

    <span class="c1"># The intersection of two axis-aligned bounding boxes is always an</span>
    <span class="c1"># axis-aligned bounding box</span>
    <span class="n">intersection_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">x_right</span> <span class="o">-</span> <span class="n">x_left</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_bottom</span> <span class="o">-</span> <span class="n">y_top</span><span class="p">)</span>

    <span class="c1"># compute the area of both AABBs</span>
    <span class="n">bb1_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">bb1</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">bb1</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">bb1</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">bb1</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">])</span>
    <span class="n">bb2_area</span> <span class="o">=</span> <span class="p">(</span><span class="n">bb2</span><span class="p">[</span><span class="s2">&quot;x2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">bb2</span><span class="p">[</span><span class="s2">&quot;x1&quot;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">bb2</span><span class="p">[</span><span class="s2">&quot;y2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">bb2</span><span class="p">[</span><span class="s2">&quot;y1&quot;</span><span class="p">])</span>

    <span class="c1"># compute the intersection over union by taking the intersection</span>
    <span class="c1"># area and dividing it by the sum of prediction + ground-truth</span>
    <span class="c1"># areas - the interesection area</span>
    <span class="n">iou</span> <span class="o">=</span> <span class="n">intersection_area</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span>
        <span class="nb">float</span><span class="p">(</span><span class="n">bb1_area</span> <span class="o">+</span> <span class="n">bb2_area</span> <span class="o">-</span> <span class="n">intersection_area</span><span class="p">),</span> <span class="n">a_min</span><span class="o">=</span><span class="n">EPSILON</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">)</span>  <span class="c1"># avoid division by 0</span>
    <span class="c1"># There are some hyper-parameters here like consider tile area/object area</span>
    <span class="k">return</span> <span class="n">iou</span>


<span class="k">def</span> <span class="nf">_has_overlap</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function determines whether each labeled box overlaps with another box of a different class (i.e. virtually the same box having multiple conflicting annotations). It returns a boolean array.&quot;&quot;&quot;</span>
    <span class="n">iou_matrix</span> <span class="o">=</span> <span class="n">_get_overlap_matrix</span><span class="p">(</span><span class="n">bbox_list</span><span class="p">,</span> <span class="n">bbox_list</span><span class="p">)</span>
    <span class="n">results_overlap</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">iou_matrix</span><span class="p">)):</span>
        <span class="n">is_overlap</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">iou_matrix</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">j</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">iou_matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">LABEL_OVERLAP_THRESHOLD</span><span class="p">:</span>
                    <span class="n">lab_1</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">lab_2</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">lab_1</span> <span class="o">!=</span> <span class="n">lab_2</span><span class="p">:</span>
                        <span class="n">is_overlap</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">results_overlap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">is_overlap</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results_overlap</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_euc_dis</span><span class="p">(</span><span class="n">box1</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">box2</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates the Euclidean distance between `box1` and `box2`.&quot;&quot;&quot;</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">box1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box1</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="n">box2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">box2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">box2</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">])</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">])</span>
    <span class="n">val2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p1</span> <span class="o">-</span> <span class="n">p2</span><span class="p">)</span> <span class="o">*</span> <span class="n">EUC_FACTOR</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">val2</span>


<span class="k">def</span> <span class="nf">_get_dist_matrix</span><span class="p">(</span><span class="n">bb1_list</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">bb2_list</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns a distance matrix of distances from all of boxes in bb1_list to all of boxes in bb2_list.&quot;&quot;&quot;</span>
    <span class="n">wd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bb1_list</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">bb2_list</span><span class="p">)))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bb1_list</span><span class="p">)):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">bb2_list</span><span class="p">)):</span>
            <span class="n">wd</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">_euc_dis</span><span class="p">(</span><span class="n">bb1_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">bb2_list</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">wd</span>


<span class="k">def</span> <span class="nf">_get_min_possible_similarity</span><span class="p">(</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">predictions</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Gets the min possible similarity score between two bounding boxes out of all images.&quot;&quot;&quot;</span>
    <span class="n">min_possible_similarity</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">for</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="n">lab_bboxes</span><span class="p">,</span> <span class="n">lab_labels</span> <span class="o">=</span> <span class="n">_separate_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
        <span class="n">pred_bboxes</span><span class="p">,</span> <span class="n">pred_labels</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_separate_prediction</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>
        <span class="n">iou_matrix</span> <span class="o">=</span> <span class="n">_get_overlap_matrix</span><span class="p">(</span><span class="n">lab_bboxes</span><span class="p">,</span> <span class="n">pred_bboxes</span><span class="p">)</span>
        <span class="n">dist_matrix</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">_get_dist_matrix</span><span class="p">(</span><span class="n">lab_bboxes</span><span class="p">,</span> <span class="n">pred_bboxes</span><span class="p">)</span>
        <span class="n">similarity_matrix</span> <span class="o">=</span> <span class="n">iou_matrix</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">dist_matrix</span><span class="p">)</span>
        <span class="n">non_zero_similarity_matrix</span> <span class="o">=</span> <span class="n">similarity_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">similarity_matrix</span><span class="p">)]</span>
        <span class="n">min_image_similarity</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">1.0</span> <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">non_zero_similarity_matrix</span><span class="o">.</span><span class="n">shape</span> <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">non_zero_similarity_matrix</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">min_possible_similarity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">min_possible_similarity</span><span class="p">,</span> <span class="n">min_image_similarity</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">min_possible_similarity</span>


<span class="k">def</span> <span class="nf">_get_valid_inputs_for_compute_scores_per_image</span><span class="p">(</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">prediction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pred_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pred_label_probs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pred_bboxes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lab_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lab_bboxes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">similarity_matrix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">iou_matrix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">min_possible_similarity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AuxiliaryTypesDict</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns valid inputs for compute scores by either passing through values or calculating the inputs internally.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">lab_labels</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">lab_bboxes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">label</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Pass in either one of label or label labels into auxiliary inputs. Both can not be None.&quot;</span>
            <span class="p">)</span>
        <span class="n">lab_bboxes</span><span class="p">,</span> <span class="n">lab_labels</span> <span class="o">=</span> <span class="n">_separate_label</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pred_labels</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pred_label_probs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pred_bboxes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">prediction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Pass in either one of prediction or prediction labels and prediction probabilities into auxiliary inputs. Both can not be None.&quot;</span>
            <span class="p">)</span>
        <span class="n">pred_bboxes</span><span class="p">,</span> <span class="n">pred_labels</span><span class="p">,</span> <span class="n">pred_label_probs</span> <span class="o">=</span> <span class="n">_separate_prediction</span><span class="p">(</span><span class="n">prediction</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">similarity_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">iou_matrix</span> <span class="o">=</span> <span class="n">_get_overlap_matrix</span><span class="p">(</span><span class="n">lab_bboxes</span><span class="p">,</span> <span class="n">pred_bboxes</span><span class="p">)</span>
        <span class="n">dist_matrix</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">_get_dist_matrix</span><span class="p">(</span><span class="n">lab_bboxes</span><span class="p">,</span> <span class="n">pred_bboxes</span><span class="p">)</span>
        <span class="n">similarity_matrix</span> <span class="o">=</span> <span class="n">iou_matrix</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">dist_matrix</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">iou_matrix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">iou_matrix</span> <span class="o">=</span> <span class="n">_get_overlap_matrix</span><span class="p">(</span><span class="n">lab_bboxes</span><span class="p">,</span> <span class="n">pred_bboxes</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">min_possible_similarity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">min_possible_similarity</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">1.0</span>
            <span class="k">if</span> <span class="mi">0</span> <span class="ow">in</span> <span class="n">similarity_matrix</span><span class="o">.</span><span class="n">shape</span>
            <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">similarity_matrix</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">similarity_matrix</span><span class="p">)])</span>
        <span class="p">)</span>

    <span class="n">auxiliary_input_dict</span><span class="p">:</span> <span class="n">AuxiliaryTypesDict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;pred_labels&quot;</span><span class="p">:</span> <span class="n">pred_labels</span><span class="p">,</span>
        <span class="s2">&quot;pred_label_probs&quot;</span><span class="p">:</span> <span class="n">pred_label_probs</span><span class="p">,</span>
        <span class="s2">&quot;pred_bboxes&quot;</span><span class="p">:</span> <span class="n">pred_bboxes</span><span class="p">,</span>
        <span class="s2">&quot;lab_labels&quot;</span><span class="p">:</span> <span class="n">lab_labels</span><span class="p">,</span>
        <span class="s2">&quot;lab_bboxes&quot;</span><span class="p">:</span> <span class="n">lab_bboxes</span><span class="p">,</span>
        <span class="s2">&quot;similarity_matrix&quot;</span><span class="p">:</span> <span class="n">similarity_matrix</span><span class="p">,</span>
        <span class="s2">&quot;iou_matrix&quot;</span><span class="p">:</span> <span class="n">iou_matrix</span><span class="p">,</span>
        <span class="s2">&quot;min_possible_similarity&quot;</span><span class="p">:</span> <span class="n">min_possible_similarity</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">auxiliary_input_dict</span>


<span class="k">def</span> <span class="nf">_get_valid_inputs_for_compute_scores</span><span class="p">(</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">predictions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">AuxiliaryTypesDict</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Takes in alpha, labels and predictions and returns auxiliary input dictionary containing divided parts of labels and prediction per image.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">predictions</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Predictions and labels can not be None. Both are needed to get valid inputs.&quot;</span>
        <span class="p">)</span>
    <span class="n">min_possible_similarity</span> <span class="o">=</span> <span class="n">_get_min_possible_similarity</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>

    <span class="n">auxiliary_inputs</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">prediction</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="n">auxiliary_input_dict</span> <span class="o">=</span> <span class="n">_get_valid_inputs_for_compute_scores_per_image</span><span class="p">(</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
            <span class="n">prediction</span><span class="o">=</span><span class="n">prediction</span><span class="p">,</span>
            <span class="n">min_possible_similarity</span><span class="o">=</span><span class="n">min_possible_similarity</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">auxiliary_inputs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auxiliary_input_dict</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">auxiliary_inputs</span>


<span class="k">def</span> <span class="nf">_get_valid_score</span><span class="p">(</span><span class="n">scores_arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given scores array, returns valid score (softmin) or 1. Checks validity of score.&quot;&quot;&quot;</span>
    <span class="n">scores_arr</span> <span class="o">=</span> <span class="n">scores_arr</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">scores_arr</span><span class="p">)]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scores_arr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">valid_score</span> <span class="o">=</span> <span class="n">softmin1d</span><span class="p">(</span><span class="n">scores_arr</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">valid_score</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">valid_score</span>


<span class="k">def</span> <span class="nf">_get_valid_subtype_score_params</span><span class="p">(</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">low_probability_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">high_probability_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function returns valid params for subtype score. If param is None, then default constant is returned&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">alpha</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">ALPHA</span>
    <span class="k">if</span> <span class="n">low_probability_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">low_probability_threshold</span> <span class="o">=</span> <span class="n">LOW_PROBABILITY_THRESHOLD</span>
    <span class="k">if</span> <span class="n">high_probability_threshold</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">high_probability_threshold</span> <span class="o">=</span> <span class="n">HIGH_PROBABILITY_THRESHOLD</span>
    <span class="k">if</span> <span class="n">temperature</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="n">TEMPERATURE</span>
    <span class="k">return</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">low_probability_threshold</span><span class="p">,</span> <span class="n">high_probability_threshold</span><span class="p">,</span> <span class="n">temperature</span>


<span class="k">def</span> <span class="nf">_get_aggregation_weights</span><span class="p">(</span>
    <span class="n">aggregation_weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This function validates aggregation weights, returning the default weights if none are provided.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">aggregation_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">aggregation_weights</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;overlooked&quot;</span><span class="p">:</span> <span class="n">CUSTOM_SCORE_WEIGHT_OVERLOOKED</span><span class="p">,</span>
            <span class="s2">&quot;swap&quot;</span><span class="p">:</span> <span class="n">CUSTOM_SCORE_WEIGHT_SWAP</span><span class="p">,</span>
            <span class="s2">&quot;badloc&quot;</span><span class="p">:</span> <span class="n">CUSTOM_SCORE_WEIGHT_BADLOC</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">assert_valid_aggregation_weights</span><span class="p">(</span><span class="n">aggregation_weights</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">aggregation_weights</span>


<span class="k">def</span> <span class="nf">_compute_overlooked_box_scores_for_image</span><span class="p">(</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">high_probability_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">prediction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pred_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pred_label_probs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pred_bboxes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lab_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lab_bboxes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">similarity_matrix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">iou_matrix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">min_possible_similarity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This method returns one score per predicted box (above threshold) in an image. Score from 0 to 1 ranking how overlooked the box is.&quot;&quot;&quot;</span>

    <span class="n">auxiliary_input_dict</span> <span class="o">=</span> <span class="n">_get_valid_inputs_for_compute_scores_per_image</span><span class="p">(</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="n">prediction</span><span class="o">=</span><span class="n">prediction</span><span class="p">,</span>
        <span class="n">pred_labels</span><span class="o">=</span><span class="n">pred_labels</span><span class="p">,</span>
        <span class="n">pred_label_probs</span><span class="o">=</span><span class="n">pred_label_probs</span><span class="p">,</span>
        <span class="n">pred_bboxes</span><span class="o">=</span><span class="n">pred_bboxes</span><span class="p">,</span>
        <span class="n">lab_labels</span><span class="o">=</span><span class="n">lab_labels</span><span class="p">,</span>
        <span class="n">lab_bboxes</span><span class="o">=</span><span class="n">lab_bboxes</span><span class="p">,</span>
        <span class="n">similarity_matrix</span><span class="o">=</span><span class="n">similarity_matrix</span><span class="p">,</span>
        <span class="n">min_possible_similarity</span><span class="o">=</span><span class="n">min_possible_similarity</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">pred_labels</span> <span class="o">=</span> <span class="n">auxiliary_input_dict</span><span class="p">[</span><span class="s2">&quot;pred_labels&quot;</span><span class="p">]</span>
    <span class="n">pred_label_probs</span> <span class="o">=</span> <span class="n">auxiliary_input_dict</span><span class="p">[</span><span class="s2">&quot;pred_label_probs&quot;</span><span class="p">]</span>
    <span class="n">lab_labels</span> <span class="o">=</span> <span class="n">auxiliary_input_dict</span><span class="p">[</span><span class="s2">&quot;lab_labels&quot;</span><span class="p">]</span>
    <span class="n">similarity_matrix</span> <span class="o">=</span> <span class="n">auxiliary_input_dict</span><span class="p">[</span><span class="s2">&quot;similarity_matrix&quot;</span><span class="p">]</span>
    <span class="n">min_possible_similarity</span> <span class="o">=</span> <span class="n">auxiliary_input_dict</span><span class="p">[</span><span class="s2">&quot;min_possible_similarity&quot;</span><span class="p">]</span>
    <span class="n">iou_matrix</span> <span class="o">=</span> <span class="n">auxiliary_input_dict</span><span class="p">[</span><span class="s2">&quot;iou_matrix&quot;</span><span class="p">]</span>

    <span class="n">scores_overlooked</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pred_labels</span><span class="p">))</span>  <span class="c1"># same length as num of predicted boxes</span>

    <span class="k">for</span> <span class="n">iid</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pred_labels</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">pred_label_probs</span><span class="p">[</span><span class="n">iid</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">high_probability_threshold</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">iou_matrix</span><span class="p">[:,</span> <span class="n">iid</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">scores_overlooked</span><span class="p">[</span><span class="n">iid</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">continue</span>

        <span class="n">k_similarity</span> <span class="o">=</span> <span class="n">similarity_matrix</span><span class="p">[</span><span class="n">lab_labels</span> <span class="o">==</span> <span class="n">k</span><span class="p">,</span> <span class="n">iid</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_similarity</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># if there are no annotated boxes of class k</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">min_possible_similarity</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">pred_label_probs</span><span class="p">[</span><span class="n">iid</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">closest_annotated_box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">k_similarity</span><span class="p">)</span>
            <span class="n">score</span> <span class="o">=</span> <span class="n">k_similarity</span><span class="p">[</span><span class="n">closest_annotated_box</span><span class="p">]</span>

        <span class="n">scores_overlooked</span><span class="p">[</span><span class="n">iid</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>

    <span class="k">return</span> <span class="n">scores_overlooked</span>


<div class="viewcode-block" id="compute_overlooked_box_scores"><a class="viewcode-back" href="../../../cleanlab/object_detection/rank.html#cleanlab.object_detection.rank.compute_overlooked_box_scores">[docs]</a><span class="k">def</span> <span class="nf">compute_overlooked_box_scores</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">predictions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">high_probability_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">auxiliary_inputs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">AuxiliaryTypesDict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns an array of overlooked box scores for each image.</span>
<span class="sd">    This is a helper method mostly for advanced users.</span>

<span class="sd">    An overlooked box error is when an image contains an object that is one of the given classes but there is no annotated bounding box around it.</span>
<span class="sd">    Score per high-confidence predicted bounding box is between 0 and 1, with lower values indicating boxes we are more confident were overlooked in the given label.</span>

<span class="sd">    Each image has ``L`` annotated bounding boxes and ``M`` predicted bounding boxes.</span>
<span class="sd">    A score is calculated for each predicted box in each of the ``N`` images in dataset.</span>

<span class="sd">    Note: ``M`` and ``L`` can be a different values for each image, as the number of annotated and predicted boxes varies.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    labels:</span>
<span class="sd">        A list of ``N`` dictionaries such that ``labels[i]`` contains the given labels for the `i`-th image.</span>
<span class="sd">        Refer to documentation for this argument in :py:func:`find_label_issues &lt;cleanlab.object_detection.filter.find_label_issues&gt;` for further details.</span>

<span class="sd">    predictions:</span>
<span class="sd">        A list of ``N`` ``np.ndarray`` such that ``predictions[i]`` corresponds to the model predictions for the `i`-th image.</span>
<span class="sd">        Refer to documentation for this argument in :py:func:`find_label_issues &lt;cleanlab.object_detection.filter.find_label_issues&gt;` for further details.</span>

<span class="sd">    alpha:</span>
<span class="sd">        Optional weighting between IoU and Euclidean distance when calculating similarity between predicted and annotated boxes. High alpha means weighting IoU more heavily over Euclidean distance. If no alpha is provided, a good default is used.</span>

<span class="sd">    high_probability_threshold:</span>
<span class="sd">        Optional probability threshold that determines which predicted boxes are considered high-confidence when computing overlooked scores. If not provided, a good default is used.</span>

<span class="sd">    auxiliary_inputs:</span>
<span class="sd">        Optional list of ``N`` dictionaries containing keys for sub-parts of label and prediction per image. Useful to minimize computation when computing multiple box scores for a single set of images. For the `i`-th image, `auxiliary_inputs[i]` should contain following keys:</span>

<span class="sd">       * pred_labels: np.ndarray</span>
<span class="sd">            Array of predicted classes for `i`-th image of shape ``(M,)``.</span>
<span class="sd">       * pred_label_probs: np.ndarray</span>
<span class="sd">            Array of predicted class probabilities for `i`-th image of shape ``(M,)``.</span>
<span class="sd">       * pred_bboxes: np.ndarray</span>
<span class="sd">            Array of predicted bounding boxes for `i`-th image of shape ``(M, 4)``.</span>
<span class="sd">       * lab_labels: np.ndarray</span>
<span class="sd">            Array of given label classed for `i`-th image of shape ``(L,)``.</span>
<span class="sd">       * lab_bboxes: np.ndarray</span>
<span class="sd">            Array of given label bounding boxes for `i`-th image of shape ``(L, 4)``.</span>
<span class="sd">       * similarity_matrix: np.ndarray</span>
<span class="sd">            Similarity matrix between labels and predictions `i`-th image.</span>
<span class="sd">       * min_possible_similarity: float</span>
<span class="sd">            Minimum possible similarity value greater than 0 between labels and predictions for the entire dataset.</span>
<span class="sd">    Returns</span>
<span class="sd">    ---------</span>
<span class="sd">    scores_overlooked:</span>
<span class="sd">        A list of ``N`` numpy arrays where scores_overlooked[i] is an array of size ``M`` of overlooked scores per predicted box for the `i`-th image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span>
        <span class="n">alpha</span><span class="p">,</span>
        <span class="n">low_probability_threshold</span><span class="p">,</span>
        <span class="n">high_probability_threshold</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">_get_valid_subtype_score_params</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">high_probability_threshold</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">auxiliary_inputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">auxiliary_inputs</span> <span class="o">=</span> <span class="n">_get_valid_inputs_for_compute_scores</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>

    <span class="n">scores_overlooked</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">auxiliary_input_dict</span> <span class="ow">in</span> <span class="n">auxiliary_inputs</span><span class="p">:</span>
        <span class="n">scores_overlooked_per_box</span> <span class="o">=</span> <span class="n">_compute_overlooked_box_scores_for_image</span><span class="p">(</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">high_probability_threshold</span><span class="o">=</span><span class="n">high_probability_threshold</span><span class="p">,</span>
            <span class="o">**</span><span class="n">auxiliary_input_dict</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">scores_overlooked</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores_overlooked_per_box</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scores_overlooked</span></div>


<span class="k">def</span> <span class="nf">_compute_badloc_box_scores_for_image</span><span class="p">(</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">low_probability_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">prediction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pred_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pred_label_probs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pred_bboxes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lab_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lab_bboxes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">similarity_matrix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">iou_matrix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">min_possible_similarity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This method returns one score per labeled box in an image. Score from 0 to 1 ranking how badly located the box is.&quot;&quot;&quot;</span>

    <span class="n">auxiliary_input_dict</span> <span class="o">=</span> <span class="n">_get_valid_inputs_for_compute_scores_per_image</span><span class="p">(</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="n">prediction</span><span class="o">=</span><span class="n">prediction</span><span class="p">,</span>
        <span class="n">pred_labels</span><span class="o">=</span><span class="n">pred_labels</span><span class="p">,</span>
        <span class="n">pred_label_probs</span><span class="o">=</span><span class="n">pred_label_probs</span><span class="p">,</span>
        <span class="n">pred_bboxes</span><span class="o">=</span><span class="n">pred_bboxes</span><span class="p">,</span>
        <span class="n">lab_labels</span><span class="o">=</span><span class="n">lab_labels</span><span class="p">,</span>
        <span class="n">lab_bboxes</span><span class="o">=</span><span class="n">lab_bboxes</span><span class="p">,</span>
        <span class="n">similarity_matrix</span><span class="o">=</span><span class="n">similarity_matrix</span><span class="p">,</span>
        <span class="n">iou_matrix</span><span class="o">=</span><span class="n">iou_matrix</span><span class="p">,</span>
        <span class="n">min_possible_similarity</span><span class="o">=</span><span class="n">min_possible_similarity</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">pred_labels</span> <span class="o">=</span> <span class="n">auxiliary_input_dict</span><span class="p">[</span><span class="s2">&quot;pred_labels&quot;</span><span class="p">]</span>
    <span class="n">pred_label_probs</span> <span class="o">=</span> <span class="n">auxiliary_input_dict</span><span class="p">[</span><span class="s2">&quot;pred_label_probs&quot;</span><span class="p">]</span>
    <span class="n">lab_labels</span> <span class="o">=</span> <span class="n">auxiliary_input_dict</span><span class="p">[</span><span class="s2">&quot;lab_labels&quot;</span><span class="p">]</span>
    <span class="n">similarity_matrix</span> <span class="o">=</span> <span class="n">auxiliary_input_dict</span><span class="p">[</span><span class="s2">&quot;similarity_matrix&quot;</span><span class="p">]</span>
    <span class="n">iou_matrix</span> <span class="o">=</span> <span class="n">auxiliary_input_dict</span><span class="p">[</span><span class="s2">&quot;iou_matrix&quot;</span><span class="p">]</span>

    <span class="n">scores_badloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lab_labels</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">iid</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lab_labels</span><span class="p">):</span>
        <span class="n">k_similarity</span> <span class="o">=</span> <span class="n">similarity_matrix</span><span class="p">[</span><span class="n">iid</span><span class="p">,</span> <span class="n">pred_labels</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">k_pred</span> <span class="o">=</span> <span class="n">pred_label_probs</span><span class="p">[</span><span class="n">pred_labels</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">k_iou</span> <span class="o">=</span> <span class="n">iou_matrix</span><span class="p">[</span><span class="n">iid</span><span class="p">,</span> <span class="n">pred_labels</span> <span class="o">==</span> <span class="n">k</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_pred</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">k_pred</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">low_probability_threshold</span><span class="p">:</span>
            <span class="n">scores_badloc</span><span class="p">[</span><span class="n">iid</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">continue</span>

        <span class="n">idx_at_least_low_probability_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">k_pred</span> <span class="o">&gt;</span> <span class="n">low_probability_threshold</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">idx_at_least_intersection_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">k_iou</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">combined_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
            <span class="n">idx_at_least_low_probability_threshold</span><span class="p">,</span> <span class="n">idx_at_least_intersection_threshold</span>
        <span class="p">)</span>

        <span class="n">k_similarity</span> <span class="o">=</span> <span class="n">k_similarity</span><span class="p">[</span><span class="n">combined_idx</span><span class="p">]</span>
        <span class="n">k_pred</span> <span class="o">=</span> <span class="n">k_pred</span><span class="p">[</span><span class="n">combined_idx</span><span class="p">]</span>

        <span class="n">scores_badloc</span><span class="p">[</span><span class="n">iid</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">k_similarity</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">k_pred</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mf">1.0</span>
    <span class="k">return</span> <span class="n">scores_badloc</span>


<div class="viewcode-block" id="compute_badloc_box_scores"><a class="viewcode-back" href="../../../cleanlab/object_detection/rank.html#cleanlab.object_detection.rank.compute_badloc_box_scores">[docs]</a><span class="k">def</span> <span class="nf">compute_badloc_box_scores</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">predictions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">low_probability_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">auxiliary_inputs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">AuxiliaryTypesDict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a numeric score for each annotated bounding box in each image, estimating the likelihood that the edges of this box are not badly located.</span>
<span class="sd">    This is a helper method mostly for advanced users.</span>

<span class="sd">    A badly located box error is when a box has the correct label but incorrect coordinates so it does not correctly encapsulate the entire object it is for.</span>
<span class="sd">    Score per high-confidence predicted bounding box is between 0 and 1, with lower values indicating boxes we are more confident were overlooked in the given label.</span>

<span class="sd">    Each image has ``L`` annotated bounding boxes and ``M`` predicted bounding boxes.</span>
<span class="sd">    A score is calculated for each predicted box in each of the ``N`` images in dataset.</span>

<span class="sd">    Note: ``M`` and ``L`` can be a different values for each image, as the number of annotated and predicted boxes varies.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    labels:</span>
<span class="sd">        A list of ``N`` dictionaries such that ``labels[i]`` contains the given labels for the `i`-th image.</span>
<span class="sd">        Refer to documentation for this argument in :py:func:`find_label_issues &lt;cleanlab.object_detection.filter.find_label_issues&gt;` for further details.</span>

<span class="sd">    predictions:</span>
<span class="sd">        A list of ``N`` ``np.ndarray`` such that ``predictions[i]`` corresponds to the model predictions for the `i`-th image.</span>
<span class="sd">        Refer to documentation for this argument in :py:func:`find_label_issues &lt;cleanlab.object_detection.filter.find_label_issues&gt;` for further details.</span>

<span class="sd">    alpha:</span>
<span class="sd">        Optional weighting between IoU and Euclidean distance when calculating similarity between predicted and annotated boxes. High alpha means weighting IoU more heavily over Euclidean distance. If no alpha is provided, a good default is used.</span>

<span class="sd">    low_probability_threshold:</span>
<span class="sd">        Optional minimum probability threshold that determines which predicted boxes are considered when computing badly located scores. If not provided, a good default is used.</span>

<span class="sd">    auxiliary_inputs:</span>
<span class="sd">        Optional list of ``N`` dictionaries containing keys for sub-parts of label and prediction per image. Useful to minimize computation when computing multiple box scores for a single set of images. For the `i`-th image, `auxiliary_inputs[i]` should contain following keys:</span>

<span class="sd">       * pred_labels: np.ndarray</span>
<span class="sd">            Array of predicted classes for `i`-th image of shape ``(M,)``.</span>
<span class="sd">       * pred_label_probs: np.ndarray</span>
<span class="sd">            Array of predicted class probabilities for `i`-th image of shape ``(M,)``.</span>
<span class="sd">       * pred_bboxes: np.ndarray</span>
<span class="sd">            Array of predicted bounding boxes for `i`-th image of shape ``(M, 4)``.</span>
<span class="sd">       * lab_labels: np.ndarray</span>
<span class="sd">            Array of given label classed for `i`-th image of shape ``(L,)``.</span>
<span class="sd">       * lab_bboxes: np.ndarray</span>
<span class="sd">            Array of given label bounding boxes for `i`-th image of shape ``(L, 4)``.</span>
<span class="sd">       * similarity_matrix: np.ndarray</span>
<span class="sd">            Similarity matrix between labels and predictions `i`-th image.</span>
<span class="sd">       * min_possible_similarity: float</span>
<span class="sd">            Minimum possible similarity value greater than 0 between labels and predictions for the entire dataset.</span>
<span class="sd">    Returns</span>
<span class="sd">    ---------</span>
<span class="sd">    scores_badloc:</span>
<span class="sd">        A list of ``N`` numpy arrays where scores_badloc[i] is an array of size ``L`` badly located scores per annotated box for the `i`-th image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span>
        <span class="n">alpha</span><span class="p">,</span>
        <span class="n">low_probability_threshold</span><span class="p">,</span>
        <span class="n">high_probability_threshold</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">_get_valid_subtype_score_params</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">low_probability_threshold</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">auxiliary_inputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">auxiliary_inputs</span> <span class="o">=</span> <span class="n">_get_valid_inputs_for_compute_scores</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>

    <span class="n">scores_badloc</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">auxiliary_input_dict</span> <span class="ow">in</span> <span class="n">auxiliary_inputs</span><span class="p">:</span>
        <span class="n">scores_badloc_per_box</span> <span class="o">=</span> <span class="n">_compute_badloc_box_scores_for_image</span><span class="p">(</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">low_probability_threshold</span><span class="o">=</span><span class="n">low_probability_threshold</span><span class="p">,</span> <span class="o">**</span><span class="n">auxiliary_input_dict</span>
        <span class="p">)</span>
        <span class="n">scores_badloc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores_badloc_per_box</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scores_badloc</span></div>


<span class="k">def</span> <span class="nf">_compute_swap_box_scores_for_image</span><span class="p">(</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">high_probability_threshold</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">prediction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pred_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pred_label_probs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pred_bboxes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lab_labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">lab_bboxes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">similarity_matrix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">iou_matrix</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">min_possible_similarity</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">overlapping_label_check</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This method returns one score per labeled box in an image. Score from 0 to 1 ranking how likeley swapped the box is.&quot;&quot;&quot;</span>

    <span class="n">auxiliary_input_dict</span> <span class="o">=</span> <span class="n">_get_valid_inputs_for_compute_scores_per_image</span><span class="p">(</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
        <span class="n">prediction</span><span class="o">=</span><span class="n">prediction</span><span class="p">,</span>
        <span class="n">pred_labels</span><span class="o">=</span><span class="n">pred_labels</span><span class="p">,</span>
        <span class="n">pred_label_probs</span><span class="o">=</span><span class="n">pred_label_probs</span><span class="p">,</span>
        <span class="n">pred_bboxes</span><span class="o">=</span><span class="n">pred_bboxes</span><span class="p">,</span>
        <span class="n">lab_labels</span><span class="o">=</span><span class="n">lab_labels</span><span class="p">,</span>
        <span class="n">lab_bboxes</span><span class="o">=</span><span class="n">lab_bboxes</span><span class="p">,</span>
        <span class="n">similarity_matrix</span><span class="o">=</span><span class="n">similarity_matrix</span><span class="p">,</span>
        <span class="n">min_possible_similarity</span><span class="o">=</span><span class="n">min_possible_similarity</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">pred_labels</span> <span class="o">=</span> <span class="n">auxiliary_input_dict</span><span class="p">[</span><span class="s2">&quot;pred_labels&quot;</span><span class="p">]</span>
    <span class="n">pred_label_probs</span> <span class="o">=</span> <span class="n">auxiliary_input_dict</span><span class="p">[</span><span class="s2">&quot;pred_label_probs&quot;</span><span class="p">]</span>
    <span class="n">lab_labels</span> <span class="o">=</span> <span class="n">auxiliary_input_dict</span><span class="p">[</span><span class="s2">&quot;lab_labels&quot;</span><span class="p">]</span>
    <span class="n">similarity_matrix</span> <span class="o">=</span> <span class="n">auxiliary_input_dict</span><span class="p">[</span><span class="s2">&quot;similarity_matrix&quot;</span><span class="p">]</span>
    <span class="n">min_possible_similarity</span> <span class="o">=</span> <span class="n">auxiliary_input_dict</span><span class="p">[</span><span class="s2">&quot;min_possible_similarity&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">overlapping_label_check</span><span class="p">:</span>
        <span class="n">has_overlap_label_bboxes</span> <span class="o">=</span> <span class="n">_has_overlap</span><span class="p">(</span><span class="n">lab_bboxes</span><span class="p">,</span> <span class="n">lab_labels</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">has_overlap_label_bboxes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">lab_labels</span><span class="p">))</span>

    <span class="n">scores_swap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lab_labels</span><span class="p">))</span>

    <span class="k">for</span> <span class="n">iid</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lab_labels</span><span class="p">):</span>
        <span class="n">not_k_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pred_labels</span> <span class="o">!=</span> <span class="n">k</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">has_overlap_label_bboxes</span><span class="p">[</span><span class="n">iid</span><span class="p">]:</span>
            <span class="n">scores_swap</span><span class="p">[</span><span class="n">iid</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_possible_similarity</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">not_k_idx</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">pred_label_probs</span><span class="p">[</span><span class="n">not_k_idx</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">high_probability_threshold</span><span class="p">):</span>
            <span class="n">scores_swap</span><span class="p">[</span><span class="n">iid</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="k">continue</span>

        <span class="n">not_k_pred</span> <span class="o">=</span> <span class="n">pred_label_probs</span><span class="p">[</span><span class="n">not_k_idx</span><span class="p">]</span>
        <span class="n">idx_at_least_high_probability_threshold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">not_k_pred</span> <span class="o">&gt;</span> <span class="n">high_probability_threshold</span><span class="p">)[</span>
            <span class="mi">0</span>
        <span class="p">]</span>
        <span class="n">not_k_similarity</span> <span class="o">=</span> <span class="n">similarity_matrix</span><span class="p">[</span><span class="n">iid</span><span class="p">,</span> <span class="n">not_k_idx</span><span class="p">][</span>
            <span class="n">idx_at_least_high_probability_threshold</span>
        <span class="p">]</span>

        <span class="n">closest_predicted_box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">not_k_similarity</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">min_possible_similarity</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">not_k_similarity</span><span class="p">[</span><span class="n">closest_predicted_box</span><span class="p">]])</span>
        <span class="n">scores_swap</span><span class="p">[</span><span class="n">iid</span><span class="p">]</span> <span class="o">=</span> <span class="n">score</span>

    <span class="k">return</span> <span class="n">scores_swap</span>


<div class="viewcode-block" id="compute_swap_box_scores"><a class="viewcode-back" href="../../../cleanlab/object_detection/rank.html#cleanlab.object_detection.rank.compute_swap_box_scores">[docs]</a><span class="k">def</span> <span class="nf">compute_swap_box_scores</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">predictions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">high_probability_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">overlapping_label_check</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">auxiliary_inputs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">AuxiliaryTypesDict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a numeric score for each annotated bounding box in each image, estimating the likelihood that the class label for this box was not accidentally swapped with another class.</span>
<span class="sd">    This is a helper method mostly for advanced users.</span>

<span class="sd">    A swapped box error occurs when a bounding box should be labeled as a class different to what the current label is.</span>
<span class="sd">    Score per high-confidence predicted bounding box is between 0 and 1, with lower values indicating boxes we are more confident were overlooked in the given label.</span>

<span class="sd">    Each image has ``L`` annotated bounding boxes and ``M`` predicted bounding boxes.</span>
<span class="sd">    A score is calculated for each predicted box in each of the ``N`` images in dataset.</span>

<span class="sd">    Note: ``M`` and ``L`` can be a different values for each image, as the number of annotated and predicted boxes varies.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    labels:</span>
<span class="sd">        A list of ``N`` dictionaries such that ``labels[i]`` contains the given labels for the `i`-th image.</span>
<span class="sd">        Refer to documentation for this argument in :py:func:`find_label_issues &lt;cleanlab.object_detection.filter.find_label_issues&gt;` for further details.</span>

<span class="sd">    predictions:</span>
<span class="sd">        A list of ``N`` ``np.ndarray`` such that ``predictions[i]`` corresponds to the model predictions for the `i`-th image.</span>
<span class="sd">        Refer to documentation for this argument in :py:func:`find_label_issues &lt;cleanlab.object_detection.filter.find_label_issues&gt;` for further details.</span>

<span class="sd">    alpha:</span>
<span class="sd">        Optional weighting between IoU and Euclidean distance when calculating similarity between predicted and annotated boxes. High alpha means weighting IoU more heavily over Euclidean distance. If no alpha is provided, a good default is used.</span>

<span class="sd">    high_probability_threshold:</span>
<span class="sd">        Optional probability threshold that determines which predicted boxes are considered high-confidence when computing overlooked scores. If not provided, a good default is used.</span>

<span class="sd">    overlapping_label_check : bool, default = True</span>
<span class="sd">        If True, boxes annotated with more than one class label have their swap score penalized. Set this to False if you are not concerned when two very similar boxes exist with different class labels in the given annotations.</span>

<span class="sd">    auxiliary_inputs:</span>
<span class="sd">        Optional list of ``N`` dictionaries containing keys for sub-parts of label and prediction per image. Useful to minimize computation when computing multiple box scores for a single set of images. For the `i`-th image, `auxiliary_inputs[i]` should contain following keys:</span>

<span class="sd">       * pred_labels: np.ndarray</span>
<span class="sd">            Array of predicted classes for `i`-th image of shape ``(M,)``.</span>
<span class="sd">       * pred_label_probs: np.ndarray</span>
<span class="sd">            Array of predicted class probabilities for `i`-th image of shape ``(M,)``.</span>
<span class="sd">       * pred_bboxes: np.ndarray</span>
<span class="sd">            Array of predicted bounding boxes for `i`-th image of shape ``(M, 4)``.</span>
<span class="sd">       * lab_labels: np.ndarray</span>
<span class="sd">            Array of given label classed for `i`-th image of shape ``(L,)``.</span>
<span class="sd">       * lab_bboxes: np.ndarray</span>
<span class="sd">            Array of given label bounding boxes for `i`-th image of shape ``(L, 4)``.</span>
<span class="sd">       * similarity_matrix: np.ndarray</span>
<span class="sd">            Similarity matrix between labels and predictions `i`-th image.</span>
<span class="sd">       * min_possible_similarity: float</span>
<span class="sd">            Minimum possible similarity value greater than 0 between labels and predictions for the entire dataset.</span>
<span class="sd">    Returns</span>
<span class="sd">    ---------</span>
<span class="sd">    scores_swap:</span>
<span class="sd">        A list of ``N`` numpy arrays where scores_swap[i] is an array of size ``L`` swap scores per annotated box for the `i`-th image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span>
        <span class="n">alpha</span><span class="p">,</span>
        <span class="n">low_probability_threshold</span><span class="p">,</span>
        <span class="n">high_probability_threshold</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">_get_valid_subtype_score_params</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">high_probability_threshold</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">auxiliary_inputs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">auxiliary_inputs</span> <span class="o">=</span> <span class="n">_get_valid_inputs_for_compute_scores</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>

    <span class="n">scores_swap</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">auxiliary_inputs</span> <span class="ow">in</span> <span class="n">auxiliary_inputs</span><span class="p">:</span>
        <span class="n">scores_swap_per_box</span> <span class="o">=</span> <span class="n">_compute_swap_box_scores_for_image</span><span class="p">(</span>
            <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
            <span class="n">high_probability_threshold</span><span class="o">=</span><span class="n">high_probability_threshold</span><span class="p">,</span>
            <span class="n">overlapping_label_check</span><span class="o">=</span><span class="n">overlapping_label_check</span><span class="p">,</span>
            <span class="o">**</span><span class="n">auxiliary_inputs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">scores_swap</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">scores_swap_per_box</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">scores_swap</span></div>


<div class="viewcode-block" id="pool_box_scores_per_image"><a class="viewcode-back" href="../../../cleanlab/object_detection/rank.html#cleanlab.object_detection.rank.pool_box_scores_per_image">[docs]</a><span class="k">def</span> <span class="nf">pool_box_scores_per_image</span><span class="p">(</span>
    <span class="n">box_scores</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="o">*</span><span class="p">,</span> <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Aggregates all per-box scores within an image to return a single quality score for the image rather than for individual boxes within it.</span>
<span class="sd">    This is a helper method mostly for advanced users to be used with the outputs of :py:func:`object_detection.rank.compute_overlooked_box_scores &lt;cleanlab.object_detection.rank.compute_overlooked_box_scores&gt;`, :py:func:`object_detection.rank.compute_badloc_box_scores &lt;cleanlab.object_detection.rank.compute_badloc_box_scores&gt;`, and :py:func:`object_detection.rank.compute_swap_box_scores &lt;cleanlab.object_detection.rank.compute_swap_box_scores&gt;`.</span>

<span class="sd">    Score per image is between 0 and 1, with lower values indicating we are more confident image contains an error.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    box_scores:</span>
<span class="sd">        A list of ``N`` numpy arrays where box_scores[i] is an array of badly located scores per box for the `i`-th image.</span>

<span class="sd">    temperature:</span>
<span class="sd">        Optional temperature of the softmin function where a lower value suggests softmin acts closer to min. If not provided, a good default is used.</span>

<span class="sd">    Returns</span>
<span class="sd">    ---------</span>
<span class="sd">    image_scores:</span>
<span class="sd">        An array of size ``N`` where ``image_scores[i]`` represents the score for the `i`-th image.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="p">(</span>
        <span class="n">alpha</span><span class="p">,</span>
        <span class="n">low_probability_threshold</span><span class="p">,</span>
        <span class="n">high_probability_threshold</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">_get_valid_subtype_score_params</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">temperature</span><span class="p">)</span>

    <span class="n">image_scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span>
        <span class="n">shape</span><span class="o">=</span><span class="p">[</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">box_scores</span><span class="p">),</span>
        <span class="p">]</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">box_score</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">box_scores</span><span class="p">):</span>
        <span class="n">image_score</span> <span class="o">=</span> <span class="n">_get_valid_score</span><span class="p">(</span><span class="n">box_score</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>
        <span class="n">image_scores</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">image_score</span>
    <span class="k">return</span> <span class="n">image_scores</span></div>


<span class="k">def</span> <span class="nf">_get_subtype_label_quality_scores</span><span class="p">(</span>
    <span class="n">labels</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
    <span class="n">predictions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">alpha</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">low_probability_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">high_probability_threshold</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">aggregation_weights</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">overlapping_label_check</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a label quality score for each of the ``N`` images in the dataset.</span>
<span class="sd">    Score is between 0 and 1.</span>

<span class="sd">    1 - clean label (given label is likely correct).</span>
<span class="sd">    0 - dirty label (given label is likely incorrect).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    labels:</span>
<span class="sd">        A list of ``N`` dictionaries such that ``labels[i]`` contains the given labels for the `i`-th image.</span>
<span class="sd">        Refer to documentation for this argument in :py:func:`find_label_issues &lt;cleanlab.object_detection.filter.find_label_issues&gt;` for further details.</span>

<span class="sd">    predictions:</span>
<span class="sd">        A list of ``N`` ``np.ndarray`` such that ``predictions[i]`` corresponds to the model predictions for the `i`-th image.</span>
<span class="sd">        Refer to documentation for this argument in :py:func:`find_label_issues &lt;cleanlab.object_detection.filter.find_label_issues&gt;` for further details.</span>

<span class="sd">    alpha:</span>
<span class="sd">        Optional weighting between IoU and Euclidean distance when calculating similarity between predicted and annotated boxes. High alpha means weighting IoU more heavily over Euclidean distance. If no alpha is provided, a good default is used.</span>

<span class="sd">    low_probability_threshold:</span>
<span class="sd">        Optional minimum probability threshold that determines which predicted boxes are considered when computing badly located scores. If not provided, a good default is used.</span>

<span class="sd">    high_probability_threshold:</span>
<span class="sd">        Optional probability threshold that determines which predicted boxes are considered high-confidence when computing overlooked and swapped scores. If not provided, a good default is used.</span>

<span class="sd">    temperature:</span>
<span class="sd">        Optional temperature of the softmin function where a lower score suggests softmin acts closer to min. If not provided, a good default is used.</span>

<span class="sd">    overlapping_label_check : bool, default = True</span>
<span class="sd">        If True, boxes annotated with more than one class label have their swap score penalized. Set this to False if you are not concerned when two very similar boxes exist with different class labels in the given annotations.</span>

<span class="sd">    Returns</span>
<span class="sd">    ---------</span>
<span class="sd">    label_quality_scores:</span>
<span class="sd">        As returned by :py:func:`get_label_quality_scores &lt;cleanlab.outlier.get_label_quality_scores&gt;`. See function for more details.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="p">(</span>
        <span class="n">alpha</span><span class="p">,</span>
        <span class="n">low_probability_threshold</span><span class="p">,</span>
        <span class="n">high_probability_threshold</span><span class="p">,</span>
        <span class="n">temperature</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">=</span> <span class="n">_get_valid_subtype_score_params</span><span class="p">(</span>
        <span class="n">alpha</span><span class="p">,</span> <span class="n">low_probability_threshold</span><span class="p">,</span> <span class="n">high_probability_threshold</span><span class="p">,</span> <span class="n">temperature</span>
    <span class="p">)</span>
    <span class="n">auxiliary_inputs</span> <span class="o">=</span> <span class="n">_get_valid_inputs_for_compute_scores</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>
    <span class="n">aggregation_weights</span> <span class="o">=</span> <span class="n">_get_aggregation_weights</span><span class="p">(</span><span class="n">aggregation_weights</span><span class="p">)</span>

    <span class="n">overlooked_scores_per_box</span> <span class="o">=</span> <span class="n">compute_overlooked_box_scores</span><span class="p">(</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">high_probability_threshold</span><span class="o">=</span><span class="n">high_probability_threshold</span><span class="p">,</span>
        <span class="n">auxiliary_inputs</span><span class="o">=</span><span class="n">auxiliary_inputs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">overlooked_score_per_image</span> <span class="o">=</span> <span class="n">pool_box_scores_per_image</span><span class="p">(</span>
        <span class="n">overlooked_scores_per_box</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span>
    <span class="p">)</span>

    <span class="n">badloc_scores_per_box</span> <span class="o">=</span> <span class="n">compute_badloc_box_scores</span><span class="p">(</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">low_probability_threshold</span><span class="o">=</span><span class="n">low_probability_threshold</span><span class="p">,</span>
        <span class="n">auxiliary_inputs</span><span class="o">=</span><span class="n">auxiliary_inputs</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">badloc_score_per_image</span> <span class="o">=</span> <span class="n">pool_box_scores_per_image</span><span class="p">(</span>
        <span class="n">badloc_scores_per_box</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span>
    <span class="p">)</span>

    <span class="n">swap_scores_per_box</span> <span class="o">=</span> <span class="n">compute_swap_box_scores</span><span class="p">(</span>
        <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span>
        <span class="n">high_probability_threshold</span><span class="o">=</span><span class="n">high_probability_threshold</span><span class="p">,</span>
        <span class="n">auxiliary_inputs</span><span class="o">=</span><span class="n">auxiliary_inputs</span><span class="p">,</span>
        <span class="n">overlapping_label_check</span><span class="o">=</span><span class="n">overlapping_label_check</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">swap_score_per_image</span> <span class="o">=</span> <span class="n">pool_box_scores_per_image</span><span class="p">(</span><span class="n">swap_scores_per_box</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">)</span>

    <span class="n">scores</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">aggregation_weights</span><span class="p">[</span><span class="s2">&quot;overlooked&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">TINY_VALUE</span> <span class="o">+</span> <span class="n">overlooked_score_per_image</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">aggregation_weights</span><span class="p">[</span><span class="s2">&quot;badloc&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">TINY_VALUE</span> <span class="o">+</span> <span class="n">badloc_score_per_image</span><span class="p">)</span>
        <span class="o">+</span> <span class="n">aggregation_weights</span><span class="p">[</span><span class="s2">&quot;swap&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">TINY_VALUE</span> <span class="o">+</span> <span class="n">swap_score_per_image</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">scores</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">scores</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">scores</span>
</pre></div> 
        </article>
      </div>
      <footer>
         
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, Cleanlab Inc.
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/cleanlab/cleanlab" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        

<script type="text/javascript">
    window.addEventListener("load", () => {
        let elements = document.getElementsByClassName("left-details");

        elements[0].insertAdjacentHTML(
            "afterbegin",
            `<code class="docutils literal notranslate"><span class="pre">cleanlab</span></code> is distributed on <a href="https://pypi.org/project/cleanlab/">PyPI</a> and <a href="https://anaconda.org/conda-forge/cleanlab">conda</a>.`
        );
    });
</script>


      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=2b91c5f0"></script>
    <script src="../../../_static/doctools.js?v=888ff710"></script>
    <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../../_static/scripts/furo.js?v=32e29ea5"></script>
    <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../../_static/copybutton.js?v=30646c52"></script>
    <script src="../../../_static/tabs.js?v=3030b3cb"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^1.0.1/dist/embed-amd.js"></script>
    
<script async defer src="https://buttons.github.io/buttons.js"></script>
</body>
</html>